<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="base-url" content="/Animal_Hospital__Dental_Department">
    <meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.">
    
    <title>Admin Dashboard | 動物醫院:牙科部 Animal_Hospital:Dental_Dept</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/Animal_Hospital__Dental_Department/assets/css/style.css">

    <!-- Scripts -->
    <script>
        // Initialize empty config in case script fails to load
        window.GITHUB_TOKEN = null;
        window.NOTIFICATION_EMAIL = null;
        console.log('Initial config setup');
        
        // Debug script loading
        function checkConfig() {
            console.log('Config check:', {
                token: window.GITHUB_TOKEN ? 'present' : 'missing',
                email: window.NOTIFICATION_EMAIL ? 'present' : 'missing',
                configScript: document.querySelector('script[src*="config.js"]')?.src
            });
        }
        setTimeout(checkConfig, 1000);
    </script>
    <!-- Load config first -->
    <script src="/Animal_Hospital__Dental_Department/assets/js/config.js" 
            onload="console.log('✓ Config loaded successfully')"
            onerror="console.error('✗ Failed to load config.js - check file path')"
            type="text/javascript"
            async="false"></script>
    <script src="/Animal_Hospital__Dental_Department/assets/js/create_labels.js"></script>
    <script src="/Animal_Hospital__Dental_Department/assets/js/lang_display.js"></script>
    <script src="/Animal_Hospital__Dental_Department/assets/js/comments.js"></script>
    
    <!-- Add CSS for image overlay -->
    <style>
        .image-container {
            position: relative;
            display: inline-block;
        }
        .text-overlay {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          color: black;
          /* text-shadow: 2px 2px 4px rgb(0, 0, 0, 0.7); */
          white-space: pre-line; /* Allows line breaks */
          font-size: 24px;
          text-align: center;
          z-index: 1;
          padding: 6px;
          margin: 3px;
          background-color: rgba(0,0,0,0.05);
          border-radius: 6px;
          border: 2px solid black; /* Debug border */
        }
    </style>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/Animal_Hospital__Dental_Department/assets/images/favicon.png">
    
    <!-- Open Graph Meta Tags for better social sharing -->
    <meta property="og:title" content="Admin Dashboard">
    <meta property="og:description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.">
    <meta property="og:url" content="https://risch315815.github.io/Animal_Hospital__Dental_Department/admin/">
</head>
<body>
    <header class="site-header">
        <div class="container">
            <h1 class="site-title"><a href="/Animal_Hospital__Dental_Department/">動物醫院:牙科部 Animal_Hospital:Dental_Dept</a></h1>
            <nav class="site-nav">
                <a href="/Animal_Hospital__Dental_Department/" 
                    
                   data-nav-id="nav_content" 
                   data-nav-index="0">首頁</a>
                <a href="/Animal_Hospital__Dental_Department/news" 
                    
                   data-nav-id="nav_content" 
                   data-nav-index="1">公告</a>
                <a href="/Animal_Hospital__Dental_Department/team" 
                    
                   data-nav-id="nav_content" 
                   data-nav-index="2">團隊成員</a>
                <a href="/Animal_Hospital__Dental_Department/contact" 
                    
                   data-nav-id="nav_content" 
                   data-nav-index="3">聯絡我們</a>
            </nav>
        </div>
    </header>


    <div class="language-selector">
        <div class="container">
            <label for="language-select" id="language-label">選擇語言</label>
            <select id="language-select" onchange="changeLanguage(this.value)">
                <option value="zh-hant" >中文</option>
                <option value="en" selected>English</option>
                <option value="fr" >Français</option>
                <option value="ja" >日本語</option>
                <option value="th" >ไทย</option>
                <option value="es" >Español</option>
            </select>
        </div>
    </div>

    <main class="site-content">
        <div class="container">


            <div class="admin-dashboard">
    <h1>Admin Dashboard</h1>
    
    <!-- Hidden elements needed for CommentSystem -->
    <div id="comments-container" style="display: none;"></div>
    
    <!-- Stats Overview -->
    <div class="stats-panel">
        <div class="stat-card pending-count">
            <h3>Pending Comments</h3>
            <div id="pending-count">Loading...</div>
        </div>
        <div class="stat-card spam-count">
            <h3>Spam Comments</h3>
            <div id="spam-count">Loading...</div>
        </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions">
        <button onclick="bulkApprove()" class="btn-approve">Approve Selected</button>
        <button onclick="bulkSpam()" class="btn-spam">Mark as Spam</button>
        <button onclick="bulkDelete()" class="btn-delete">Delete Selected</button>
        <button onclick="window.runTests()" class="btn-test">Run Tests</button>
    </div>

    <!-- Comment Moderation -->
    
<div class="moderation-panel">
    <h3>Comment Moderation</h3>
    <div id="pending-comments">
        Loading pending comments...
    </div>
</div>

<script>
async function loadPendingComments() {
    const response = await fetch(
        'https://api.github.com/repos/Risch315815/Animal_Hospital__Dental_Department/issues?labels=comment:pending'
    );
    const comments = await response.json();
    
    const container = document.getElementById('pending-comments');
    container.innerHTML = comments.map(comment => `
        <div class="pending-comment">
            <input type="checkbox" 
                   onchange="window.adminDashboard.selectedComments.has(${comment.number}) ? 
                            window.adminDashboard.selectedComments.delete(${comment.number}) : 
                            window.adminDashboard.selectedComments.add(${comment.number})">
            <div class="comment-header">
                <span>${comment.title}</span>
                <span>${new Date(comment.created_at).toLocaleDateString()}</span>
            </div>
            <div class="comment-body">${comment.body}</div>
            <div class="moderation-controls">
                <button onclick="window.commentSystem.approveComment(${comment.number})">Approve</button>
                <button onclick="window.commentSystem.markAsSpam(${comment.number})">Mark as Spam</button>
            </div>
        </div>
    `).join('') || 'No pending comments';
}

document.addEventListener('DOMContentLoaded', loadPendingComments);
</script>
 

    <!-- Email Notifications -->
    <div class="notification-settings">
        <h3>Email Notifications</h3>
        <div class="notification-options">
            <label>
                <input type="checkbox" id="notify-new" name="notify-new" checked>
                New comments
            </label>
            <label>
                <input type="checkbox" id="notify-spam" name="notify-spam" checked>
                Spam detected
            </label>
            <label>
                <input type="checkbox" id="notify-bulk" name="notify-bulk" checked>
                Bulk actions
            </label>
        </div>
        <input type="email" id="notification-email" placeholder="Email address" value="{{ site.email }}" >
        <button onclick="saveNotificationSettings()">Save Settings</button>
    </div>
</div>

<!-- Admin Styles -->
<style>
.admin-dashboard {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.stats-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    padding: 20px;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.bulk-actions {
    margin: 20px 0;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
}

.bulk-actions button {
    margin-right: 10px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-approve { background: #238636; color: white; }
.btn-spam { background: #dc3545; color: white; }
.btn-delete { background: #6c757d; color: white; }

.notification-settings {
    margin-top: 30px;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
</style>

<!-- Admin Scripts -->
<script>
class AdminDashboard {
    constructor() {
        this.selectedComments = new Set();
        this.initializeStats();
        this.setupNotifications();
    }

    async initializeStats() {
        await this.updateCommentCounts();
        setInterval(() => this.updateCommentCounts(), 60000); // Update every minute
    }

    async updateCommentCounts() {
        const pendingCount = document.getElementById('pending-count');
        const spamCount = document.getElementById('spam-count');

        try {
            const pending = await this.fetchComments('comment:pending');
            const spam = await this.fetchComments('comment:spam');
            
            pendingCount.textContent = pending.length;
            spamCount.textContent = spam.length;
        } catch (error) {
            console.error('Error updating counts:', error);
        }
    }

    async fetchComments(label) {
        const response = await fetch(
            `https://api.github.com/repos/Risch315815/Animal_Hospital__Dental_Department/issues?labels=${label}`,
            {
                headers: {
                    'Authorization': `token ${CONFIG.GITHUB_TOKEN}`
                }
            }
        );
        return await response.json();
    }

    async bulkApprove() {
        for (const issueNumber of this.selectedComments) {
            await window.commentSystem.approveComment(issueNumber);
        }
        this.selectedComments.clear();
        this.updateCommentCounts();
    }

    async bulkSpam() {
        for (const issueNumber of this.selectedComments) {
            await window.commentSystem.markAsSpam(issueNumber);
        }
        this.selectedComments.clear();
        this.updateCommentCounts();
    }

    async bulkDelete() {
        if (!confirm('Are you sure you want to delete these comments?')) return;
        
        for (const issueNumber of this.selectedComments) {
            await this.deleteComment(issueNumber);
        }
        this.selectedComments.clear();
        this.updateCommentCounts();
    }

    async deleteComment(issueNumber) {
        try {
            const response = await fetch(
                `https://api.github.com/repos/Risch315815/Animal_Hospital__Dental_Department/issues/${issueNumber}`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ state: 'closed' })
                }
            );
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        } catch (error) {
            console.error(`Error deleting comment ${issueNumber}:`, error);
        }
    }

    setupNotifications() {
        // Get elements
        const emailInput = document.getElementById('notification-email');
        const newCheck = document.getElementById('notify-new');
        const spamCheck = document.getElementById('notify-spam');
        const bulkCheck = document.getElementById('notify-bulk');
        
        // Exit if elements don't exist
        if (!emailInput || !newCheck || !spamCheck || !bulkCheck) {
            console.warn('Notification elements not found');
            return;
        }
        
        // Load saved settings
        const email = localStorage.getItem('notificationEmail');
        const enabled = localStorage.getItem('notificationsEnabled') === 'true';
        
        emailInput.value = email || CONFIG.NOTIFICATION_EMAIL || '';
        newCheck.checked = enabled;
        spamCheck.checked = enabled;
        bulkCheck.checked = enabled;
    }

    async saveNotificationSettings() {
        const emailInput = document.getElementById('notification-email');
        const newCheck = document.getElementById('notify-new');
        const spamCheck = document.getElementById('notify-spam');
        const bulkCheck = document.getElementById('notify-bulk');
        
        if (!emailInput || !newCheck || !spamCheck || !bulkCheck) {
            console.warn('Notification elements not found');
            return;
        }
        
        const email = emailInput.value;
        const notifications = {
            new: newCheck.checked,
            spam: spamCheck.checked,
            bulk: bulkCheck.checked
        };
        
        localStorage.setItem('notificationEmail', email);
        localStorage.setItem('notificationSettings', JSON.stringify(notifications));

        alert('Notification settings saved!');
    }
}

// Initialize dashboard when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.adminDashboard = new AdminDashboard();
});

// Global functions for onclick handlers
function bulkApprove() { window.adminDashboard.bulkApprove(); }
function bulkSpam() { window.adminDashboard.bulkSpam(); }
function bulkDelete() { window.adminDashboard.bulkDelete(); }
function toggleNotifications() { window.adminDashboard.toggleNotifications(); }
function saveNotificationSettings() { window.adminDashboard.saveNotificationSettings(); }
</script> 
        </div>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2025 動物醫院:牙科部 Animal_Hospital:Dental_Dept. All rights reserved.</p>
                <div class="social-links">
                    
                    <a href="https://github.com/Risch315815" target="_blank">GitHub</a>
                    
                    
                    <a href="https://twitter.com/jekyllrb" target="_blank">Twitter</a>
                    
                </div>
            </div>
        </div>
    </footer>


</body>
</html>
